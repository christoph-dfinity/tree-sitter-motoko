=========
Random.mo
=========

/// Random number generation.

import Array "Array";
import VarArray "VarArray";
import Nat8 "Nat8";
import Nat64 "Nat64";
import Int "Int";
import Nat "Nat";
import Blob "Blob";
import Iter "Iter";
import Runtime "Runtime";
import PRNG "internal/PRNG";

module {

  let rawRand = (actor "aaaaa-aa" : actor { raw_rand : () -> async Blob }).raw_rand;

  public let blob : shared () -> async Blob = rawRand;

  /// Creates a fast pseudo-random number generator using the SFC64 algorithm.
  /// This provides statistical randomness suitable for simulations and testing,
  /// but should not be used for cryptographic purposes.
  /// The seed blob's first 8 bytes are used to initialize the PRNG.
  public func fast(seed : Nat64) : Random {
    let prng = PRNG.sfc64a();
    prng.init(seed);
    fromGenerator(
      func() {
        // Generate 8 bytes directly from a single 64-bit number
        let n = prng.next();
        // TODO: optimize using Array.tabulate or even better: a new primitive
        let bytes = VarArray.repeat<Nat8>(0, 8);
        bytes[0] := Nat8.fromNat(Nat64.toNat(n & 0xFF));
        bytes[1] := Nat8.fromNat(Nat64.toNat((n >> 8) & 0xFF));
        bytes[2] := Nat8.fromNat(Nat64.toNat((n >> 16) & 0xFF));
        bytes[3] := Nat8.fromNat(Nat64.toNat((n >> 24) & 0xFF));
        bytes[4] := Nat8.fromNat(Nat64.toNat((n >> 32) & 0xFF));
        bytes[5] := Nat8.fromNat(Nat64.toNat((n >> 40) & 0xFF));
        bytes[6] := Nat8.fromNat(Nat64.toNat((n >> 48) & 0xFF));
        bytes[7] := Nat8.fromNat(Nat64.toNat((n >> 56) & 0xFF));
        Blob.fromArray(Array.fromVarArray(bytes))
      }
    )
  };

  /// Creates a random number generator suitable for cryptography
  /// using entropy from the ICP management canister with automatic resupply.
  public func crypto() : AsyncRandom {
    fromAsyncGenerator(func() : async* Blob { await rawRand() })
  };

  public func fromGenerator(generator : () -> Blob) : Random {
    var iter : Iter.Iter<Nat8> = Iter.empty();
    let bitIter : Iter.Iter<Bool> = object {
      var mask = 0x00 : Nat8;
      var byte = 0x00 : Nat8;
      public func next() : ?Bool {
        if (0 : Nat8 == mask) {
          switch (iter.next()) {
            case null null;
            case (?w) {
              byte := w;
              mask := 0x40;
              ?(0 : Nat8 != byte & (0x80 : Nat8))
            }
          }
        } else {
          let m = mask;
          mask >>= (1 : Nat8);
          ?(0 : Nat8 != byte & m)
        }
      }
    };
    Random({
      nextBit = func() {
        switch (bitIter.next()) {
          case (?bit) { bit };
          case null {
            iter := generator().vals();
            switch (bitIter.next()) {
              case (?bit) { bit };
              case null Runtime.trap("Random.bool(): generator produced empty Blob")
            }
          }
        }
      };
      nextByte = func() {
        switch (iter.next()) {
          case (?byte) { byte };
          case null {
            iter := generator().vals();
            switch (iter.next()) {
              case (?byte) { byte };
              case null Runtime.trap("Random.nat8(): generator produced empty Blob")
            }
          }
        }
      }
    })
  };

  public func fromAsyncGenerator(generator : () -> async* Blob) : AsyncRandom {
    var iter : Iter.Iter<Nat8> = Iter.empty();
    let bitIter : Iter.Iter<Bool> = object {
      var mask = 0x00 : Nat8;
      var byte = 0x00 : Nat8;
      public func next() : ?Bool {
        if (0 : Nat8 == mask) {
          switch (iter.next()) {
            case null null;
            case (?w) {
              byte := w;
              mask := 0x40;
              ?(0 : Nat8 != byte & (0x80 : Nat8))
            }
          }
        } else {
          let m = mask;
          mask >>= (1 : Nat8);
          ?(0 : Nat8 != byte & m)
        }
      }
    };
    AsyncRandom({
      nextBit = func() : async* Bool {
        switch (bitIter.next()) {
          case (?bit) { bit };
          case null {
            iter := (await* generator()).vals();
            switch (bitIter.next()) {
              case (?bit) { bit };
              case null Runtime.trap("Random.bool(): generator produced empty Blob")
            }
          }
        }
      };
      nextByte = func() : async* Nat8 {
        switch (iter.next()) {
          case (?byte) { byte };
          case null {
            iter := (await* generator()).vals();
            switch (iter.next()) {
              case (?byte) { byte };
              case null Runtime.trap("Random.nat8(): generator produced empty Blob")
            }
          }
        }
      }
    })
  };

  public class Random({
    nextBit : () -> Bool;
    nextByte : () -> Nat8
  }) {
    /// Random choice between `true` and `false`.
    public let bool = nextBit;

    /// Random `Nat8` value in the range [0, 256).
    public let nat8 = nextByte;

    // Helper function which returns a uniformly sampled `Nat64` in the range `[0, max]`.
    // Uses rejection sampling to ensure uniform distribution even when the range
    // doesn't divide evenly into 2^64. This avoids modulo bias that would occur
    // from simply taking the modulo of a random 64-bit number.
    func uniform64(max : Nat64) : Nat64 {
      if (max == 0) {
        return 0
      };
      if (max == Nat64.maxValue) {
        return nat64()
      };
      let toExclusive = max + 1;
      // 2^64 - (2^64 % toExclusive) = (2^64-1) - (2^64-1 % toExclusive):
      let cutoff = Nat64.maxValue - (Nat64.maxValue % toExclusive);
      // 2^64 / toExclusive, with toExclusive > 1:
      let multiple = Nat64.fromNat(/* 2^64 */ 0x10000000000000000 / Nat64.toNat(toExclusive));
      loop {
        // Build up a random Nat64 from bytes
        var number = nat64();
        // If number is below cutoff, we can use it
        if (number < cutoff) {
          // Scale down to desired range
          return number / multiple
        };
        // Otherwise reject and try again
      }
    };

    public func nat64() : Nat64 {
      // prettier-ignore
      (Nat64.fromNat(Nat8.toNat(nat8())) << 56) |
      (Nat64.fromNat(Nat8.toNat(nat8())) << 48) |
      (Nat64.fromNat(Nat8.toNat(nat8())) << 40) |
      (Nat64.fromNat(Nat8.toNat(nat8())) << 32) |
      (Nat64.fromNat(Nat8.toNat(nat8())) << 24) |
      (Nat64.fromNat(Nat8.toNat(nat8())) << 16) |
      (Nat64.fromNat(Nat8.toNat(nat8())) << 8) |
      (Nat64.fromNat(Nat8.toNat(nat8())))
    };

    public func nat64Range(fromInclusive : Nat64, toExclusive : Nat64) : Nat64 {
      if (fromInclusive >= toExclusive) {
        Runtime.trap("Random.nat64Range(): fromInclusive >= toExclusive")
      };
      uniform64(toExclusive - fromInclusive - 1) + fromInclusive
    };

    public func natRange(fromInclusive : Nat, toExclusive : Nat) : Nat {
      if (fromInclusive >= toExclusive) {
        Runtime.trap("Random.natRange(): fromInclusive >= toExclusive")
      };
      Nat64.toNat(uniform64(Nat64.fromNat(toExclusive - fromInclusive - 1))) + fromInclusive
    };

    public func intRange(fromInclusive : Int, toExclusive : Int) : Int {
      if (fromInclusive >= toExclusive) {
        Runtime.trap("Random.intRange(): fromInclusive >= toExclusive")
      };
      Nat64.toNat(uniform64(Nat64.fromNat(Nat.fromInt(toExclusive - fromInclusive - 1)))) + fromInclusive
    };

  };

  public class AsyncRandom({
    nextBit : () -> async* Bool;
    nextByte : () -> async* Nat8
  }) {
    /// Random choice between `true` and `false`.
    public let bool = nextBit;

    /// Random `Nat8` value in the range [0, 256).
    public let nat8 = nextByte;

    // Helper function which returns a uniformly sampled `Nat64` in the range `[0, max]`.
    // Uses rejection sampling to ensure uniform distribution even when the range
    // doesn't divide evenly into 2^64. This avoids modulo bias that would occur
    // from simply taking the modulo of a random 64-bit number.
    func uniform64(max : Nat64) : async* Nat64 {
      if (max == 0) {
        return 0
      };
      if (max == Nat64.maxValue) {
        return await* nat64()
      };
      let toExclusive = max + 1;
      // 2^64 - (2^64 % toExclusive) = (2^64-1) - (2^64-1 % toExclusive):
      let cutoff = Nat64.maxValue - (Nat64.maxValue % toExclusive);
      // 2^64 / toExclusive, with toExclusive > 1:
      let multiple = Nat64.fromNat(/* 2^64 */ 0x10000000000000000 / Nat64.toNat(toExclusive));
      loop {
        // Build up a random Nat64 from bytes
        var number = await* nat64();
        // If number is below cutoff, we can use it
        if (number < cutoff) {
          // Scale down to desired range
          return number / multiple
        };
        // Otherwise reject and try again
      }
    };

    public func nat64() : async* Nat64 {
      // prettier-ignore
      (Nat64.fromNat(Nat8.toNat(await* nat8())) << 56) |
      (Nat64.fromNat(Nat8.toNat(await* nat8())) << 48) |
      (Nat64.fromNat(Nat8.toNat(await* nat8())) << 40) |
      (Nat64.fromNat(Nat8.toNat(await* nat8())) << 32) |
      (Nat64.fromNat(Nat8.toNat(await* nat8())) << 24) |
      (Nat64.fromNat(Nat8.toNat(await* nat8())) << 16) |
      (Nat64.fromNat(Nat8.toNat(await* nat8())) << 8) |
      (Nat64.fromNat(Nat8.toNat(await* nat8())))
    };

    public func nat64Range(fromInclusive : Nat64, toExclusive : Nat64) : async* Nat64 {
      if (fromInclusive >= toExclusive) {
        Runtime.trap("Random.nat64Range(): fromInclusive >= toExclusive")
      };
      (await* uniform64(toExclusive - fromInclusive - 1)) + fromInclusive
    };

    public func natRange(fromInclusive : Nat, toExclusive : Nat) : async* Nat {
      if (fromInclusive >= toExclusive) {
        Runtime.trap("Random.natRange(): fromInclusive >= toExclusive")
      };
      Nat64.toNat(await* uniform64(Nat64.fromNat(toExclusive - fromInclusive - 1))) + fromInclusive
    };

    public func intRange(fromInclusive : Int, toExclusive : Int) : async* Int {
      if (fromInclusive >= toExclusive) {
        Runtime.trap("Random.intRange(): fromInclusive >= toExclusive")
      };
      Nat64.toNat(await* uniform64(Nat64.fromNat(Nat.fromInt(toExclusive - fromInclusive - 1)))) + fromInclusive
    };

  };

}

---

(source_file
  (doc_comment)
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (import
    (var_pat
      (identifier))
    (text_literal))
  (obj_dec
    (obj_sort)
    (obj_body
      (dec_field
        (let_dec
          (var_pat
            (identifier))
          (dot_exp_object
            (par_exp
              (annot_exp_object
                (actor_exp
                  (lit_exp
                    (text_literal)))
                (obj_sort_typ
                  (obj_typ
                    (val_tf
                      (identifier)
                      (func_typ
                        (tup_typ)
                        (async_typ
                          (path_typ
                            (typ_path
                              (type_identifier))))))))))
            (identifier))))
      (dec_field
        (vis)
        (let_dec
          (annot_pat
            (var_pat
              (identifier))
            (typ_annot
              (func_typ
                (tup_typ)
                (async_typ
                  (path_typ
                    (typ_path
                      (type_identifier)))))))
          (var_exp
            (identifier))))
      (doc_comment)
      (doc_comment)
      (doc_comment)
      (doc_comment)
      (dec_field
        (vis)
        (func_dec
          (identifier)
          (tup_pat
            (annot_pat
              (var_pat
                (identifier))
              (typ_annot
                (path_typ
                  (typ_path
                    (type_identifier))))))
          (typ_annot
            (path_typ
              (typ_path
                (type_identifier))))
          (func_body
            (block_exp
              (let_dec
                (var_pat
                  (identifier))
                (call_exp_object
                  (dot_exp_object
                    (var_exp
                      (identifier))
                    (identifier))
                  (par_exp)))
              (exp_dec
                (call_exp_object
                  (dot_exp_object
                    (var_exp
                      (identifier))
                    (identifier))
                  (par_exp
                    (var_exp
                      (identifier)))))
              (exp_dec
                (call_exp_object
                  (var_exp
                    (identifier))
                  (par_exp
                    (func_exp
                      (tup_pat)
                      (func_body
                        (block_exp
                          (line_comment)
                          (let_dec
                            (var_pat
                              (identifier))
                            (call_exp_object
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))
                              (par_exp)))
                          (line_comment)
                          (let_dec
                            (var_pat
                              (identifier))
                            (call_exp_object
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))
                              (inst
                                (path_typ
                                  (typ_path
                                    (type_identifier))))
                              (par_exp
                                (lit_exp
                                  (int_literal))
                                (lit_exp
                                  (int_literal)))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (var_exp
                                          (identifier))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (par_exp
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (rel_op)
                                            (lit_exp
                                              (int_literal))))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (par_exp
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (rel_op)
                                            (lit_exp
                                              (int_literal))))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (par_exp
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (rel_op)
                                            (lit_exp
                                              (int_literal))))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (par_exp
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (rel_op)
                                            (lit_exp
                                              (int_literal))))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (par_exp
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (rel_op)
                                            (lit_exp
                                              (int_literal))))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (par_exp
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (rel_op)
                                            (lit_exp
                                              (int_literal))))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (assign_exp_object
                              (array_idx_exp_object
                                (var_exp
                                  (identifier))
                                (lit_exp
                                  (int_literal)))
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (par_exp
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (rel_op)
                                            (lit_exp
                                              (int_literal))))
                                        (bin_op)
                                        (lit_exp
                                          (hex_literal)))))))))
                          (exp_dec
                            (call_exp_object
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))
                              (par_exp
                                (call_exp_object
                                  (dot_exp_object
                                    (var_exp
                                      (identifier))
                                    (identifier))
                                  (par_exp
                                    (var_exp
                                      (identifier)))))))))))))))))
      (doc_comment)
      (doc_comment)
      (dec_field
        (vis)
        (func_dec
          (identifier)
          (tup_pat)
          (typ_annot
            (path_typ
              (typ_path
                (type_identifier))))
          (func_body
            (block_exp
              (exp_dec
                (call_exp_object
                  (var_exp
                    (identifier))
                  (par_exp
                    (func_exp
                      (tup_pat)
                      (typ_annot
                        (async_typ
                          (path_typ
                            (typ_path
                              (type_identifier)))))
                      (func_body
                        (block_exp
                          (exp_dec
                            (await_exp
                              (call_exp_block
                                (var_exp
                                  (identifier))
                                (par_exp))))))))))))))
      (dec_field
        (vis)
        (func_dec
          (identifier)
          (tup_pat
            (annot_pat
              (var_pat
                (identifier))
              (typ_annot
                (func_typ
                  (tup_typ)
                  (path_typ
                    (typ_path
                      (type_identifier)))))))
          (typ_annot
            (path_typ
              (typ_path
                (type_identifier))))
          (func_body
            (block_exp
              (var_dec
                (var_pat
                  (identifier))
                (typ_annot
                  (path_typ
                    (typ_path
                      (identifier)
                      (type_identifier))
                    (path_typ
                      (typ_path
                        (type_identifier)))))
                (call_exp_object
                  (dot_exp_object
                    (var_exp
                      (identifier))
                    (identifier))
                  (par_exp)))
              (let_dec
                (annot_pat
                  (var_pat
                    (identifier))
                  (typ_annot
                    (path_typ
                      (typ_path
                        (identifier)
                        (type_identifier))
                      (path_typ
                        (typ_path
                          (type_identifier))))))
                (obj_dec
                  (obj_sort)
                  (obj_body
                    (dec_field
                      (var_dec
                        (var_pat
                          (identifier))
                        (annot_exp_object
                          (lit_exp
                            (hex_literal))
                          (path_typ
                            (typ_path
                              (type_identifier))))))
                    (dec_field
                      (var_dec
                        (var_pat
                          (identifier))
                        (annot_exp_object
                          (lit_exp
                            (hex_literal))
                          (path_typ
                            (typ_path
                              (type_identifier))))))
                    (dec_field
                      (vis)
                      (func_dec
                        (identifier)
                        (tup_pat)
                        (typ_annot
                          (quest_typ
                            (path_typ
                              (typ_path
                                (type_identifier)))))
                        (func_body
                          (block_exp
                            (exp_dec
                              (if_exp
                                (par_exp
                                  (bin_exp_object
                                    (annot_exp_object
                                      (lit_exp
                                        (int_literal))
                                      (path_typ
                                        (typ_path
                                          (type_identifier))))
                                    (rel_op)
                                    (var_exp
                                      (identifier))))
                                (block_exp
                                  (exp_dec
                                    (switch_exp
                                      (par_exp
                                        (call_exp_object
                                          (dot_exp_object
                                            (var_exp
                                              (identifier))
                                            (identifier))
                                          (par_exp)))
                                      (case
                                        (lit_pat
                                          (null_literal))
                                        (lit_exp
                                          (null_literal)))
                                      (case
                                        (tup_pat
                                          (quest_pat
                                            (var_pat
                                              (identifier))))
                                        (block_exp
                                          (exp_dec
                                            (assign_exp_object
                                              (var_exp
                                                (identifier))
                                              (var_exp
                                                (identifier))))
                                          (exp_dec
                                            (assign_exp_object
                                              (var_exp
                                                (identifier))
                                              (lit_exp
                                                (hex_literal))))
                                          (exp_dec
                                            (quest_exp
                                              (par_exp
                                                (bin_exp_object
                                                  (bin_exp_object
                                                    (annot_exp_object
                                                      (lit_exp
                                                        (int_literal))
                                                      (path_typ
                                                        (typ_path
                                                          (type_identifier))))
                                                    (rel_op)
                                                    (var_exp
                                                      (identifier)))
                                                  (bin_op)
                                                  (par_exp
                                                    (annot_exp_object
                                                      (lit_exp
                                                        (hex_literal))
                                                      (path_typ
                                                        (typ_path
                                                          (type_identifier))))))))))))))
                                (block_exp
                                  (let_dec
                                    (var_pat
                                      (identifier))
                                    (var_exp
                                      (identifier)))
                                  (exp_dec
                                    (binassign_exp_object
                                      (var_exp
                                        (identifier))
                                      (binassign_op)
                                      (par_exp
                                        (annot_exp_object
                                          (lit_exp
                                            (int_literal))
                                          (path_typ
                                            (typ_path
                                              (type_identifier)))))))
                                  (exp_dec
                                    (quest_exp
                                      (par_exp
                                        (bin_exp_object
                                          (bin_exp_object
                                            (annot_exp_object
                                              (lit_exp
                                                (int_literal))
                                              (path_typ
                                                (typ_path
                                                  (type_identifier))))
                                            (rel_op)
                                            (var_exp
                                              (identifier)))
                                          (bin_op)
                                          (var_exp
                                            (identifier))))))))))))))))
              (exp_dec
                (call_exp_object
                  (var_exp
                    (identifier))
                  (par_exp
                    (object_exp
                      (exp_field
                        (identifier)
                        (func_exp
                          (tup_pat)
                          (func_body
                            (block_exp
                              (exp_dec
                                (switch_exp
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp)))
                                  (case
                                    (tup_pat
                                      (quest_pat
                                        (var_pat
                                          (identifier))))
                                    (block_exp
                                      (exp_dec
                                        (var_exp
                                          (identifier)))))
                                  (case
                                    (lit_pat
                                      (null_literal))
                                    (block_exp
                                      (exp_dec
                                        (assign_exp_object
                                          (var_exp
                                            (identifier))
                                          (call_exp_object
                                            (dot_exp_object
                                              (call_exp_object
                                                (var_exp
                                                  (identifier))
                                                (par_exp))
                                              (identifier))
                                            (par_exp))))
                                      (exp_dec
                                        (switch_exp
                                          (par_exp
                                            (call_exp_object
                                              (dot_exp_object
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp)))
                                          (case
                                            (tup_pat
                                              (quest_pat
                                                (var_pat
                                                  (identifier))))
                                            (block_exp
                                              (exp_dec
                                                (var_exp
                                                  (identifier)))))
                                          (case
                                            (lit_pat
                                              (null_literal))
                                            (call_exp_block
                                              (dot_exp_block
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp
                                                (lit_exp
                                                  (text_literal)))))))))))))))
                      (exp_field
                        (identifier)
                        (func_exp
                          (tup_pat)
                          (func_body
                            (block_exp
                              (exp_dec
                                (switch_exp
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp)))
                                  (case
                                    (tup_pat
                                      (quest_pat
                                        (var_pat
                                          (identifier))))
                                    (block_exp
                                      (exp_dec
                                        (var_exp
                                          (identifier)))))
                                  (case
                                    (lit_pat
                                      (null_literal))
                                    (block_exp
                                      (exp_dec
                                        (assign_exp_object
                                          (var_exp
                                            (identifier))
                                          (call_exp_object
                                            (dot_exp_object
                                              (call_exp_object
                                                (var_exp
                                                  (identifier))
                                                (par_exp))
                                              (identifier))
                                            (par_exp))))
                                      (exp_dec
                                        (switch_exp
                                          (par_exp
                                            (call_exp_object
                                              (dot_exp_object
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp)))
                                          (case
                                            (tup_pat
                                              (quest_pat
                                                (var_pat
                                                  (identifier))))
                                            (block_exp
                                              (exp_dec
                                                (var_exp
                                                  (identifier)))))
                                          (case
                                            (lit_pat
                                              (null_literal))
                                            (call_exp_block
                                              (dot_exp_block
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp
                                                (lit_exp
                                                  (text_literal)))))))))))))))))))))))
      (dec_field
        (vis)
        (func_dec
          (identifier)
          (tup_pat
            (annot_pat
              (var_pat
                (identifier))
              (typ_annot
                (func_typ
                  (tup_typ)
                  (async_typ
                    (path_typ
                      (typ_path
                        (type_identifier))))))))
          (typ_annot
            (path_typ
              (typ_path
                (type_identifier))))
          (func_body
            (block_exp
              (var_dec
                (var_pat
                  (identifier))
                (typ_annot
                  (path_typ
                    (typ_path
                      (identifier)
                      (type_identifier))
                    (path_typ
                      (typ_path
                        (type_identifier)))))
                (call_exp_object
                  (dot_exp_object
                    (var_exp
                      (identifier))
                    (identifier))
                  (par_exp)))
              (let_dec
                (annot_pat
                  (var_pat
                    (identifier))
                  (typ_annot
                    (path_typ
                      (typ_path
                        (identifier)
                        (type_identifier))
                      (path_typ
                        (typ_path
                          (type_identifier))))))
                (obj_dec
                  (obj_sort)
                  (obj_body
                    (dec_field
                      (var_dec
                        (var_pat
                          (identifier))
                        (annot_exp_object
                          (lit_exp
                            (hex_literal))
                          (path_typ
                            (typ_path
                              (type_identifier))))))
                    (dec_field
                      (var_dec
                        (var_pat
                          (identifier))
                        (annot_exp_object
                          (lit_exp
                            (hex_literal))
                          (path_typ
                            (typ_path
                              (type_identifier))))))
                    (dec_field
                      (vis)
                      (func_dec
                        (identifier)
                        (tup_pat)
                        (typ_annot
                          (quest_typ
                            (path_typ
                              (typ_path
                                (type_identifier)))))
                        (func_body
                          (block_exp
                            (exp_dec
                              (if_exp
                                (par_exp
                                  (bin_exp_object
                                    (annot_exp_object
                                      (lit_exp
                                        (int_literal))
                                      (path_typ
                                        (typ_path
                                          (type_identifier))))
                                    (rel_op)
                                    (var_exp
                                      (identifier))))
                                (block_exp
                                  (exp_dec
                                    (switch_exp
                                      (par_exp
                                        (call_exp_object
                                          (dot_exp_object
                                            (var_exp
                                              (identifier))
                                            (identifier))
                                          (par_exp)))
                                      (case
                                        (lit_pat
                                          (null_literal))
                                        (lit_exp
                                          (null_literal)))
                                      (case
                                        (tup_pat
                                          (quest_pat
                                            (var_pat
                                              (identifier))))
                                        (block_exp
                                          (exp_dec
                                            (assign_exp_object
                                              (var_exp
                                                (identifier))
                                              (var_exp
                                                (identifier))))
                                          (exp_dec
                                            (assign_exp_object
                                              (var_exp
                                                (identifier))
                                              (lit_exp
                                                (hex_literal))))
                                          (exp_dec
                                            (quest_exp
                                              (par_exp
                                                (bin_exp_object
                                                  (bin_exp_object
                                                    (annot_exp_object
                                                      (lit_exp
                                                        (int_literal))
                                                      (path_typ
                                                        (typ_path
                                                          (type_identifier))))
                                                    (rel_op)
                                                    (var_exp
                                                      (identifier)))
                                                  (bin_op)
                                                  (par_exp
                                                    (annot_exp_object
                                                      (lit_exp
                                                        (hex_literal))
                                                      (path_typ
                                                        (typ_path
                                                          (type_identifier))))))))))))))
                                (block_exp
                                  (let_dec
                                    (var_pat
                                      (identifier))
                                    (var_exp
                                      (identifier)))
                                  (exp_dec
                                    (binassign_exp_object
                                      (var_exp
                                        (identifier))
                                      (binassign_op)
                                      (par_exp
                                        (annot_exp_object
                                          (lit_exp
                                            (int_literal))
                                          (path_typ
                                            (typ_path
                                              (type_identifier)))))))
                                  (exp_dec
                                    (quest_exp
                                      (par_exp
                                        (bin_exp_object
                                          (bin_exp_object
                                            (annot_exp_object
                                              (lit_exp
                                                (int_literal))
                                              (path_typ
                                                (typ_path
                                                  (type_identifier))))
                                            (rel_op)
                                            (var_exp
                                              (identifier)))
                                          (bin_op)
                                          (var_exp
                                            (identifier))))))))))))))))
              (exp_dec
                (call_exp_object
                  (var_exp
                    (identifier))
                  (par_exp
                    (object_exp
                      (exp_field
                        (identifier)
                        (func_exp
                          (tup_pat)
                          (typ_annot
                            (async_typ
                              (path_typ
                                (typ_path
                                  (type_identifier)))))
                          (func_body
                            (block_exp
                              (exp_dec
                                (switch_exp
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp)))
                                  (case
                                    (tup_pat
                                      (quest_pat
                                        (var_pat
                                          (identifier))))
                                    (block_exp
                                      (exp_dec
                                        (var_exp
                                          (identifier)))))
                                  (case
                                    (lit_pat
                                      (null_literal))
                                    (block_exp
                                      (exp_dec
                                        (assign_exp_object
                                          (var_exp
                                            (identifier))
                                          (call_exp_object
                                            (dot_exp_object
                                              (par_exp
                                                (awaitstar_exp
                                                  (call_exp_block
                                                    (var_exp
                                                      (identifier))
                                                    (par_exp))))
                                              (identifier))
                                            (par_exp))))
                                      (exp_dec
                                        (switch_exp
                                          (par_exp
                                            (call_exp_object
                                              (dot_exp_object
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp)))
                                          (case
                                            (tup_pat
                                              (quest_pat
                                                (var_pat
                                                  (identifier))))
                                            (block_exp
                                              (exp_dec
                                                (var_exp
                                                  (identifier)))))
                                          (case
                                            (lit_pat
                                              (null_literal))
                                            (call_exp_block
                                              (dot_exp_block
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp
                                                (lit_exp
                                                  (text_literal)))))))))))))))
                      (exp_field
                        (identifier)
                        (func_exp
                          (tup_pat)
                          (typ_annot
                            (async_typ
                              (path_typ
                                (typ_path
                                  (type_identifier)))))
                          (func_body
                            (block_exp
                              (exp_dec
                                (switch_exp
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp)))
                                  (case
                                    (tup_pat
                                      (quest_pat
                                        (var_pat
                                          (identifier))))
                                    (block_exp
                                      (exp_dec
                                        (var_exp
                                          (identifier)))))
                                  (case
                                    (lit_pat
                                      (null_literal))
                                    (block_exp
                                      (exp_dec
                                        (assign_exp_object
                                          (var_exp
                                            (identifier))
                                          (call_exp_object
                                            (dot_exp_object
                                              (par_exp
                                                (awaitstar_exp
                                                  (call_exp_block
                                                    (var_exp
                                                      (identifier))
                                                    (par_exp))))
                                              (identifier))
                                            (par_exp))))
                                      (exp_dec
                                        (switch_exp
                                          (par_exp
                                            (call_exp_object
                                              (dot_exp_object
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp)))
                                          (case
                                            (tup_pat
                                              (quest_pat
                                                (var_pat
                                                  (identifier))))
                                            (block_exp
                                              (exp_dec
                                                (var_exp
                                                  (identifier)))))
                                          (case
                                            (lit_pat
                                              (null_literal))
                                            (call_exp_block
                                              (dot_exp_block
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp
                                                (lit_exp
                                                  (text_literal)))))))))))))))))))))))
      (dec_field
        (vis)
        (class_dec
          (type_identifier)
          (tup_pat
            (obj_pat
              (pat_field
                (identifier)
                (typ_annot
                  (func_typ
                    (tup_typ)
                    (path_typ
                      (typ_path
                        (type_identifier))))))
              (pat_field
                (identifier)
                (typ_annot
                  (func_typ
                    (tup_typ)
                    (path_typ
                      (typ_path
                        (type_identifier))))))))
          (class_body
            (obj_body
              (doc_comment)
              (dec_field
                (vis)
                (let_dec
                  (var_pat
                    (identifier))
                  (var_exp
                    (identifier))))
              (doc_comment)
              (dec_field
                (vis)
                (let_dec
                  (var_pat
                    (identifier))
                  (var_exp
                    (identifier))))
              (line_comment)
              (line_comment)
              (line_comment)
              (line_comment)
              (dec_field
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (path_typ
                      (typ_path
                        (type_identifier))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (lit_exp
                                (int_literal))))
                          (block_exp
                            (exp_dec
                              (return_exp
                                (lit_exp
                                  (int_literal)))))))
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (return_exp
                                (call_exp_object
                                  (var_exp
                                    (identifier))
                                  (par_exp)))))))
                      (let_dec
                        (var_pat
                          (identifier))
                        (bin_exp_object
                          (var_exp
                            (identifier))
                          (bin_op)
                          (lit_exp
                            (int_literal))))
                      (line_comment)
                      (let_dec
                        (var_pat
                          (identifier))
                        (bin_exp_object
                          (dot_exp_object
                            (var_exp
                              (identifier))
                            (identifier))
                          (bin_op)
                          (par_exp
                            (bin_exp_object
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))
                              (bin_op)
                              (var_exp
                                (identifier))))))
                      (line_comment)
                      (let_dec
                        (var_pat
                          (identifier))
                        (call_exp_object
                          (dot_exp_object
                            (var_exp
                              (identifier))
                            (identifier))
                          (par_exp
                            (block_comment
                              (comment_text))
                            (bin_exp_object
                              (lit_exp
                                (hex_literal))
                              (bin_op)
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (var_exp
                                    (identifier))))))))
                      (exp_dec
                        (loop_exp
                          (block_exp
                            (line_comment)
                            (var_dec
                              (var_pat
                                (identifier))
                              (call_exp_object
                                (var_exp
                                  (identifier))
                                (par_exp)))
                            (line_comment)
                            (exp_dec
                              (if_exp
                                (par_exp
                                  (bin_exp_object
                                    (var_exp
                                      (identifier))
                                    (rel_op)
                                    (var_exp
                                      (identifier))))
                                (block_exp
                                  (line_comment)
                                  (exp_dec
                                    (return_exp
                                      (bin_exp_object
                                        (var_exp
                                          (identifier))
                                        (bin_op)
                                        (var_exp
                                          (identifier))))))))
                            (line_comment))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat)
                  (typ_annot
                    (path_typ
                      (typ_path
                        (type_identifier))))
                  (func_body
                    (block_exp
                      (line_comment)
                      (exp_dec
                        (bin_exp_object
                          (bin_exp_object
                            (bin_exp_object
                              (bin_exp_object
                                (bin_exp_object
                                  (bin_exp_object
                                    (bin_exp_object
                                      (par_exp
                                        (bin_exp_object
                                          (call_exp_object
                                            (dot_exp_object
                                              (var_exp
                                                (identifier))
                                              (identifier))
                                            (par_exp
                                              (call_exp_object
                                                (dot_exp_object
                                                  (var_exp
                                                    (identifier))
                                                  (identifier))
                                                (par_exp
                                                  (call_exp_object
                                                    (var_exp
                                                      (identifier))
                                                    (par_exp))))))
                                          (rel_op)
                                          (lit_exp
                                            (int_literal))))
                                      (bin_op)
                                      (par_exp
                                        (bin_exp_object
                                          (call_exp_object
                                            (dot_exp_object
                                              (var_exp
                                                (identifier))
                                              (identifier))
                                            (par_exp
                                              (call_exp_object
                                                (dot_exp_object
                                                  (var_exp
                                                    (identifier))
                                                  (identifier))
                                                (par_exp
                                                  (call_exp_object
                                                    (var_exp
                                                      (identifier))
                                                    (par_exp))))))
                                          (rel_op)
                                          (lit_exp
                                            (int_literal)))))
                                    (bin_op)
                                    (par_exp
                                      (bin_exp_object
                                        (call_exp_object
                                          (dot_exp_object
                                            (var_exp
                                              (identifier))
                                            (identifier))
                                          (par_exp
                                            (call_exp_object
                                              (dot_exp_object
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp
                                                (call_exp_object
                                                  (var_exp
                                                    (identifier))
                                                  (par_exp))))))
                                        (rel_op)
                                        (lit_exp
                                          (int_literal)))))
                                  (bin_op)
                                  (par_exp
                                    (bin_exp_object
                                      (call_exp_object
                                        (dot_exp_object
                                          (var_exp
                                            (identifier))
                                          (identifier))
                                        (par_exp
                                          (call_exp_object
                                            (dot_exp_object
                                              (var_exp
                                                (identifier))
                                              (identifier))
                                            (par_exp
                                              (call_exp_object
                                                (var_exp
                                                  (identifier))
                                                (par_exp))))))
                                      (rel_op)
                                      (lit_exp
                                        (int_literal)))))
                                (bin_op)
                                (par_exp
                                  (bin_exp_object
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp
                                        (call_exp_object
                                          (dot_exp_object
                                            (var_exp
                                              (identifier))
                                            (identifier))
                                          (par_exp
                                            (call_exp_object
                                              (var_exp
                                                (identifier))
                                              (par_exp))))))
                                    (rel_op)
                                    (lit_exp
                                      (int_literal)))))
                              (bin_op)
                              (par_exp
                                (bin_exp_object
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (call_exp_object
                                        (dot_exp_object
                                          (var_exp
                                            (identifier))
                                          (identifier))
                                        (par_exp
                                          (call_exp_object
                                            (var_exp
                                              (identifier))
                                            (par_exp))))))
                                  (rel_op)
                                  (lit_exp
                                    (int_literal)))))
                            (bin_op)
                            (par_exp
                              (bin_exp_object
                                (call_exp_object
                                  (dot_exp_object
                                    (var_exp
                                      (identifier))
                                    (identifier))
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp
                                        (call_exp_object
                                          (var_exp
                                            (identifier))
                                          (par_exp))))))
                                (rel_op)
                                (lit_exp
                                  (int_literal)))))
                          (bin_op)
                          (par_exp
                            (call_exp_object
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))
                              (par_exp
                                (call_exp_object
                                  (dot_exp_object
                                    (var_exp
                                      (identifier))
                                    (identifier))
                                  (par_exp
                                    (call_exp_object
                                      (var_exp
                                        (identifier))
                                      (par_exp)))))))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier)))))
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (path_typ
                      (typ_path
                        (type_identifier))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (var_exp
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (lit_exp
                                    (text_literal))))))))
                      (exp_dec
                        (bin_exp_object
                          (call_exp_object
                            (var_exp
                              (identifier))
                            (par_exp
                              (bin_exp_object
                                (bin_exp_object
                                  (var_exp
                                    (identifier))
                                  (bin_op)
                                  (var_exp
                                    (identifier)))
                                (bin_op)
                                (lit_exp
                                  (int_literal)))))
                          (bin_op)
                          (var_exp
                            (identifier))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier)))))
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (path_typ
                      (typ_path
                        (type_identifier))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (var_exp
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (lit_exp
                                    (text_literal))))))))
                      (exp_dec
                        (bin_exp_object
                          (call_exp_object
                            (dot_exp_object
                              (var_exp
                                (identifier))
                              (identifier))
                            (par_exp
                              (call_exp_object
                                (var_exp
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (bin_exp_object
                                        (bin_exp_object
                                          (var_exp
                                            (identifier))
                                          (bin_op)
                                          (var_exp
                                            (identifier)))
                                        (bin_op)
                                        (lit_exp
                                          (int_literal)))))))))
                          (bin_op)
                          (var_exp
                            (identifier))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier)))))
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (path_typ
                      (typ_path
                        (type_identifier))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (var_exp
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (lit_exp
                                    (text_literal))))))))
                      (exp_dec
                        (bin_exp_object
                          (call_exp_object
                            (dot_exp_object
                              (var_exp
                                (identifier))
                              (identifier))
                            (par_exp
                              (call_exp_object
                                (var_exp
                                  (identifier))
                                (par_exp
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (call_exp_object
                                        (dot_exp_object
                                          (var_exp
                                            (identifier))
                                          (identifier))
                                        (par_exp
                                          (bin_exp_object
                                            (bin_exp_object
                                              (var_exp
                                                (identifier))
                                              (bin_op)
                                              (var_exp
                                                (identifier)))
                                            (bin_op)
                                            (lit_exp
                                              (int_literal)))))))))))
                          (bin_op)
                          (var_exp
                            (identifier))))))))))))
      (dec_field
        (vis)
        (class_dec
          (type_identifier)
          (tup_pat
            (obj_pat
              (pat_field
                (identifier)
                (typ_annot
                  (func_typ
                    (tup_typ)
                    (async_typ
                      (path_typ
                        (typ_path
                          (type_identifier)))))))
              (pat_field
                (identifier)
                (typ_annot
                  (func_typ
                    (tup_typ)
                    (async_typ
                      (path_typ
                        (typ_path
                          (type_identifier)))))))))
          (class_body
            (obj_body
              (doc_comment)
              (dec_field
                (vis)
                (let_dec
                  (var_pat
                    (identifier))
                  (var_exp
                    (identifier))))
              (doc_comment)
              (dec_field
                (vis)
                (let_dec
                  (var_pat
                    (identifier))
                  (var_exp
                    (identifier))))
              (line_comment)
              (line_comment)
              (line_comment)
              (line_comment)
              (dec_field
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (async_typ
                      (path_typ
                        (typ_path
                          (type_identifier)))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (lit_exp
                                (int_literal))))
                          (block_exp
                            (exp_dec
                              (return_exp
                                (lit_exp
                                  (int_literal)))))))
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (return_exp
                                (awaitstar_exp
                                  (call_exp_block
                                    (var_exp
                                      (identifier))
                                    (par_exp))))))))
                      (let_dec
                        (var_pat
                          (identifier))
                        (bin_exp_object
                          (var_exp
                            (identifier))
                          (bin_op)
                          (lit_exp
                            (int_literal))))
                      (line_comment)
                      (let_dec
                        (var_pat
                          (identifier))
                        (bin_exp_object
                          (dot_exp_object
                            (var_exp
                              (identifier))
                            (identifier))
                          (bin_op)
                          (par_exp
                            (bin_exp_object
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))
                              (bin_op)
                              (var_exp
                                (identifier))))))
                      (line_comment)
                      (let_dec
                        (var_pat
                          (identifier))
                        (call_exp_object
                          (dot_exp_object
                            (var_exp
                              (identifier))
                            (identifier))
                          (par_exp
                            (block_comment
                              (comment_text))
                            (bin_exp_object
                              (lit_exp
                                (hex_literal))
                              (bin_op)
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (var_exp
                                    (identifier))))))))
                      (exp_dec
                        (loop_exp
                          (block_exp
                            (line_comment)
                            (var_dec
                              (var_pat
                                (identifier))
                              (awaitstar_exp
                                (call_exp_block
                                  (var_exp
                                    (identifier))
                                  (par_exp))))
                            (line_comment)
                            (exp_dec
                              (if_exp
                                (par_exp
                                  (bin_exp_object
                                    (var_exp
                                      (identifier))
                                    (rel_op)
                                    (var_exp
                                      (identifier))))
                                (block_exp
                                  (line_comment)
                                  (exp_dec
                                    (return_exp
                                      (bin_exp_object
                                        (var_exp
                                          (identifier))
                                        (bin_op)
                                        (var_exp
                                          (identifier))))))))
                            (line_comment))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat)
                  (typ_annot
                    (async_typ
                      (path_typ
                        (typ_path
                          (type_identifier)))))
                  (func_body
                    (block_exp
                      (line_comment)
                      (exp_dec
                        (bin_exp_object
                          (bin_exp_object
                            (bin_exp_object
                              (bin_exp_object
                                (bin_exp_object
                                  (bin_exp_object
                                    (bin_exp_object
                                      (par_exp
                                        (bin_exp_object
                                          (call_exp_object
                                            (dot_exp_object
                                              (var_exp
                                                (identifier))
                                              (identifier))
                                            (par_exp
                                              (call_exp_object
                                                (dot_exp_object
                                                  (var_exp
                                                    (identifier))
                                                  (identifier))
                                                (par_exp
                                                  (awaitstar_exp
                                                    (call_exp_block
                                                      (var_exp
                                                        (identifier))
                                                      (par_exp)))))))
                                          (rel_op)
                                          (lit_exp
                                            (int_literal))))
                                      (bin_op)
                                      (par_exp
                                        (bin_exp_object
                                          (call_exp_object
                                            (dot_exp_object
                                              (var_exp
                                                (identifier))
                                              (identifier))
                                            (par_exp
                                              (call_exp_object
                                                (dot_exp_object
                                                  (var_exp
                                                    (identifier))
                                                  (identifier))
                                                (par_exp
                                                  (awaitstar_exp
                                                    (call_exp_block
                                                      (var_exp
                                                        (identifier))
                                                      (par_exp)))))))
                                          (rel_op)
                                          (lit_exp
                                            (int_literal)))))
                                    (bin_op)
                                    (par_exp
                                      (bin_exp_object
                                        (call_exp_object
                                          (dot_exp_object
                                            (var_exp
                                              (identifier))
                                            (identifier))
                                          (par_exp
                                            (call_exp_object
                                              (dot_exp_object
                                                (var_exp
                                                  (identifier))
                                                (identifier))
                                              (par_exp
                                                (awaitstar_exp
                                                  (call_exp_block
                                                    (var_exp
                                                      (identifier))
                                                    (par_exp)))))))
                                        (rel_op)
                                        (lit_exp
                                          (int_literal)))))
                                  (bin_op)
                                  (par_exp
                                    (bin_exp_object
                                      (call_exp_object
                                        (dot_exp_object
                                          (var_exp
                                            (identifier))
                                          (identifier))
                                        (par_exp
                                          (call_exp_object
                                            (dot_exp_object
                                              (var_exp
                                                (identifier))
                                              (identifier))
                                            (par_exp
                                              (awaitstar_exp
                                                (call_exp_block
                                                  (var_exp
                                                    (identifier))
                                                  (par_exp)))))))
                                      (rel_op)
                                      (lit_exp
                                        (int_literal)))))
                                (bin_op)
                                (par_exp
                                  (bin_exp_object
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp
                                        (call_exp_object
                                          (dot_exp_object
                                            (var_exp
                                              (identifier))
                                            (identifier))
                                          (par_exp
                                            (awaitstar_exp
                                              (call_exp_block
                                                (var_exp
                                                  (identifier))
                                                (par_exp)))))))
                                    (rel_op)
                                    (lit_exp
                                      (int_literal)))))
                              (bin_op)
                              (par_exp
                                (bin_exp_object
                                  (call_exp_object
                                    (dot_exp_object
                                      (var_exp
                                        (identifier))
                                      (identifier))
                                    (par_exp
                                      (call_exp_object
                                        (dot_exp_object
                                          (var_exp
                                            (identifier))
                                          (identifier))
                                        (par_exp
                                          (awaitstar_exp
                                            (call_exp_block
                                              (var_exp
                                                (identifier))
                                              (par_exp)))))))
                                  (rel_op)
                                  (lit_exp
                                    (int_literal)))))
                            (bin_op)
                            (par_exp
                              (bin_exp_object
                                (call_exp_object
                                  (dot_exp_object
                                    (var_exp
                                      (identifier))
                                    (identifier))
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp
                                        (awaitstar_exp
                                          (call_exp_block
                                            (var_exp
                                              (identifier))
                                            (par_exp)))))))
                                (rel_op)
                                (lit_exp
                                  (int_literal)))))
                          (bin_op)
                          (par_exp
                            (call_exp_object
                              (dot_exp_object
                                (var_exp
                                  (identifier))
                                (identifier))
                              (par_exp
                                (call_exp_object
                                  (dot_exp_object
                                    (var_exp
                                      (identifier))
                                    (identifier))
                                  (par_exp
                                    (awaitstar_exp
                                      (call_exp_block
                                        (var_exp
                                          (identifier))
                                        (par_exp))))))))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier)))))
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (async_typ
                      (path_typ
                        (typ_path
                          (type_identifier)))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (var_exp
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (lit_exp
                                    (text_literal))))))))
                      (exp_dec
                        (bin_exp_object
                          (par_exp
                            (awaitstar_exp
                              (call_exp_block
                                (var_exp
                                  (identifier))
                                (par_exp
                                  (bin_exp_object
                                    (bin_exp_object
                                      (var_exp
                                        (identifier))
                                      (bin_op)
                                      (var_exp
                                        (identifier)))
                                    (bin_op)
                                    (lit_exp
                                      (int_literal)))))))
                          (bin_op)
                          (var_exp
                            (identifier))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier)))))
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (async_typ
                      (path_typ
                        (typ_path
                          (type_identifier)))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (var_exp
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (lit_exp
                                    (text_literal))))))))
                      (exp_dec
                        (bin_exp_object
                          (call_exp_object
                            (dot_exp_object
                              (var_exp
                                (identifier))
                              (identifier))
                            (par_exp
                              (awaitstar_exp
                                (call_exp_block
                                  (var_exp
                                    (identifier))
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp
                                        (bin_exp_object
                                          (bin_exp_object
                                            (var_exp
                                              (identifier))
                                            (bin_op)
                                            (var_exp
                                              (identifier)))
                                          (bin_op)
                                          (lit_exp
                                            (int_literal))))))))))
                          (bin_op)
                          (var_exp
                            (identifier))))))))
              (dec_field
                (vis)
                (func_dec
                  (identifier)
                  (tup_pat
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier)))))
                    (annot_pat
                      (var_pat
                        (identifier))
                      (typ_annot
                        (path_typ
                          (typ_path
                            (type_identifier))))))
                  (typ_annot
                    (async_typ
                      (path_typ
                        (typ_path
                          (type_identifier)))))
                  (func_body
                    (block_exp
                      (exp_dec
                        (if_exp
                          (par_exp
                            (bin_exp_object
                              (var_exp
                                (identifier))
                              (rel_op)
                              (var_exp
                                (identifier))))
                          (block_exp
                            (exp_dec
                              (call_exp_object
                                (dot_exp_object
                                  (var_exp
                                    (identifier))
                                  (identifier))
                                (par_exp
                                  (lit_exp
                                    (text_literal))))))))
                      (exp_dec
                        (bin_exp_object
                          (call_exp_object
                            (dot_exp_object
                              (var_exp
                                (identifier))
                              (identifier))
                            (par_exp
                              (awaitstar_exp
                                (call_exp_block
                                  (var_exp
                                    (identifier))
                                  (par_exp
                                    (call_exp_object
                                      (dot_exp_object
                                        (var_exp
                                          (identifier))
                                        (identifier))
                                      (par_exp
                                        (call_exp_object
                                          (dot_exp_object
                                            (var_exp
                                              (identifier))
                                            (identifier))
                                          (par_exp
                                            (bin_exp_object
                                              (bin_exp_object
                                                (var_exp
                                                  (identifier))
                                                (bin_op)
                                                (var_exp
                                                  (identifier)))
                                              (bin_op)
                                              (lit_exp
                                                (int_literal))))))))))))
                          (bin_op)
                          (var_exp
                            (identifier)))))))))))))))
