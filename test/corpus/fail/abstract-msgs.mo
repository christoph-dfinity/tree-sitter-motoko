=========
abstract-msgs.mo
=========

// In function definitions, parameters with abstract types are not fine
do { shared func foo<A <: Any>( x : A ) : () = (); };
do { shared func foo<A <: Any>() : ?A = null; };
do { func foo<A <: Any>() : () = do {
  do { shared func bar( x : A ) : () = (); };
  do { shared func bar() : async ?A { null } };
}};

// In function calls, parameters with abstract types are not fine
do { func foo<A <: Any>( f : shared A -> (), x : A )  = (f x); };
do { func foo<A <: Any>( f : shared () -> async A ) : async A = async { await (f ())}; };

// Just in types, away from definitions and calls, parameters with abstract types are still not fine
do { let x : ?(shared <A <: Any>A -> ()) = null; };
do { let x : ?(shared <A <: Any>() -> async A) = null; };
do { let x : ?(<A <: Any>(shared A -> ()) -> ()) = null; };
do { let x : ?(<A <: Any>(shared () -> async A) -> ()) = null; };


// Phantom parameters are fine
do {
  type X<B <: Any> = shared () -> ();
  func foo<A <: Any>() { shared func bar(f : X<A>) {}; () }
};

---

(source_file
  (line_comment)
  (exp_dec
    (do_exp
      (block_exp
        (func_dec
          (shared_pat)
          (identifier)
          (typ_params
            (typ_bind
              (type_identifier)
              (path_typ
                (typ_path
                  (type_identifier)))))
          (tup_pat
            (annot_pat
              (var_pat
                (identifier))
              (typ_annot
                (path_typ
                  (typ_path
                    (type_identifier))))))
          (typ_annot
            (tup_typ))
          (func_body
            (par_exp))))))
  (exp_dec
    (do_exp
      (block_exp
        (func_dec
          (shared_pat)
          (identifier)
          (typ_params
            (typ_bind
              (type_identifier)
              (path_typ
                (typ_path
                  (type_identifier)))))
          (tup_pat)
          (typ_annot
            (quest_typ
              (path_typ
                (typ_path
                  (type_identifier)))))
          (func_body
            (lit_exp
              (null_literal)))))))
  (exp_dec
    (do_exp
      (block_exp
        (func_dec
          (identifier)
          (typ_params
            (typ_bind
              (type_identifier)
              (path_typ
                (typ_path
                  (type_identifier)))))
          (tup_pat)
          (typ_annot
            (tup_typ))
          (func_body
            (do_exp
              (block_exp
                (exp_dec
                  (do_exp
                    (block_exp
                      (func_dec
                        (shared_pat)
                        (identifier)
                        (tup_pat
                          (annot_pat
                            (var_pat
                              (identifier))
                            (typ_annot
                              (path_typ
                                (typ_path
                                  (type_identifier))))))
                        (typ_annot
                          (tup_typ))
                        (func_body
                          (par_exp))))))
                (exp_dec
                  (do_exp
                    (block_exp
                      (func_dec
                        (shared_pat)
                        (identifier)
                        (tup_pat)
                        (typ_annot
                          (async_typ
                            (quest_typ
                              (path_typ
                                (typ_path
                                  (type_identifier))))))
                        (func_body
                          (block_exp
                            (exp_dec
                              (lit_exp
                                (null_literal))))))))))))))))
  (line_comment)
  (exp_dec
    (do_exp
      (block_exp
        (func_dec
          (identifier)
          (typ_params
            (typ_bind
              (type_identifier)
              (path_typ
                (typ_path
                  (type_identifier)))))
          (tup_pat
            (annot_pat
              (var_pat
                (identifier))
              (typ_annot
                (func_typ
                  (path_typ
                    (typ_path
                      (type_identifier)))
                  (tup_typ))))
            (annot_pat
              (var_pat
                (identifier))
              (typ_annot
                (path_typ
                  (typ_path
                    (type_identifier))))))
          (func_body
            (par_exp
              (call_exp_object
                (var_exp
                  (identifier))
                (var_exp
                  (identifier)))))))))
  (exp_dec
    (do_exp
      (block_exp
        (func_dec
          (identifier)
          (typ_params
            (typ_bind
              (type_identifier)
              (path_typ
                (typ_path
                  (type_identifier)))))
          (tup_pat
            (annot_pat
              (var_pat
                (identifier))
              (typ_annot
                (func_typ
                  (tup_typ)
                  (async_typ
                    (path_typ
                      (typ_path
                        (type_identifier))))))))
          (typ_annot
            (async_typ
              (path_typ
                (typ_path
                  (type_identifier)))))
          (func_body
            (async_exp
              (block_exp
                (exp_dec
                  (await_exp
                    (par_exp
                      (call_exp_object
                        (var_exp
                          (identifier))
                        (par_exp))))))))))))
  (line_comment)
  (exp_dec
    (do_exp
      (block_exp
        (let_dec
          (annot_pat
            (var_pat
              (identifier))
            (typ_annot
              (quest_typ
                (tup_typ
                  (typ_item
                    (func_typ
                      (typ_params
                        (typ_bind
                          (type_identifier)
                          (path_typ
                            (typ_path
                              (type_identifier)))))
                      (path_typ
                        (typ_path
                          (type_identifier)))
                      (tup_typ)))))))
          (lit_exp
            (null_literal))))))
  (exp_dec
    (do_exp
      (block_exp
        (let_dec
          (annot_pat
            (var_pat
              (identifier))
            (typ_annot
              (quest_typ
                (tup_typ
                  (typ_item
                    (func_typ
                      (typ_params
                        (typ_bind
                          (type_identifier)
                          (path_typ
                            (typ_path
                              (type_identifier)))))
                      (tup_typ)
                      (async_typ
                        (path_typ
                          (typ_path
                            (type_identifier))))))))))
          (lit_exp
            (null_literal))))))
  (exp_dec
    (do_exp
      (block_exp
        (let_dec
          (annot_pat
            (var_pat
              (identifier))
            (typ_annot
              (quest_typ
                (tup_typ
                  (typ_item
                    (func_typ
                      (typ_params
                        (typ_bind
                          (type_identifier)
                          (path_typ
                            (typ_path
                              (type_identifier)))))
                      (tup_typ
                        (typ_item
                          (func_typ
                            (path_typ
                              (typ_path
                                (type_identifier)))
                            (tup_typ))))
                      (tup_typ)))))))
          (lit_exp
            (null_literal))))))
  (exp_dec
    (do_exp
      (block_exp
        (let_dec
          (annot_pat
            (var_pat
              (identifier))
            (typ_annot
              (quest_typ
                (tup_typ
                  (typ_item
                    (func_typ
                      (typ_params
                        (typ_bind
                          (type_identifier)
                          (path_typ
                            (typ_path
                              (type_identifier)))))
                      (tup_typ
                        (typ_item
                          (func_typ
                            (tup_typ)
                            (async_typ
                              (path_typ
                                (typ_path
                                  (type_identifier)))))))
                      (tup_typ)))))))
          (lit_exp
            (null_literal))))))
  (line_comment)
  (exp_dec
    (do_exp
      (block_exp
        (typ_dec
          (type_identifier)
          (typ_params
            (typ_bind
              (type_identifier)
              (path_typ
                (typ_path
                  (type_identifier)))))
          (func_typ
            (tup_typ)
            (tup_typ)))
        (func_dec
          (identifier)
          (typ_params
            (typ_bind
              (type_identifier)
              (path_typ
                (typ_path
                  (type_identifier)))))
          (tup_pat)
          (func_body
            (block_exp
              (func_dec
                (shared_pat)
                (identifier)
                (tup_pat
                  (annot_pat
                    (var_pat
                      (identifier))
                    (typ_annot
                      (path_typ
                        (typ_path
                          (type_identifier))
                        (path_typ
                          (typ_path
                            (type_identifier)))))))
                (func_body
                  (block_exp)))
              (exp_dec
                (par_exp)))))))))
